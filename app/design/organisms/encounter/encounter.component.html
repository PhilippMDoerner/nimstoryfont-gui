@if (encounter() || state() === "CREATE") {
  <h4 class="card__heading">
    @switch (state()) {
      @case ("DISPLAY") {
        <ng-container [ngTemplateOutlet]="displayHeading" />
      }
      @case ("UPDATE") {
        <ng-container [ngTemplateOutlet]="updateHeading" />
      }
      @case ("OUTDATEDUPDATE") {
        <ng-container [ngTemplateOutlet]="updateHeading" />
      }
      @case ("CREATE") {
        <ng-container [ngTemplateOutlet]="createHeading" />
      }
    }

    @if (canUpdate()) {
      <app-edit-toggle
        #toggleButton
        class="card__edit-button"
        [buttonKind]="'DARK'"
        [toggled]="state() !== 'DISPLAY'"
        [hotkey]="'e'"
        [showTooltip]="showHotkeyHelp()"
        (hotkeyPressed)="
          isInFocus() ? onToggle(!toggleButton.toggled()) : undefined
        "
        (toggle)="onToggle($event)"
      ></app-edit-toggle>
    }
  </h4>

  @switch (state()) {
    @case ("DISPLAY") {
      <ng-container [ngTemplateOutlet]="displayBody" />
    }
    @case ("UPDATE") {
      <ng-container [ngTemplateOutlet]="updateBody" />
    }
    @case ("OUTDATEDUPDATE") {
      <ng-container [ngTemplateOutlet]="updateBody" />
    }
    @case ("CREATE") {
      <ng-container [ngTemplateOutlet]="createBody" />
    }
  }
}

<ng-template #displayHeading>
  {{ encounter()?.title }}
</ng-template>

<ng-template #displayBody>
  <!-- Encounter -->
  @let encounterVal = encounter();
  @if (encounterVal) {
    <div class="card__text">
      <app-html-text [text]="encounterVal.description"></app-html-text>
    </div>
  }

  <app-separator></app-separator>

  <!-- Encounter Connections -->
  <div class="card__connections">
    <app-badge-list
      [label]="'Characters'"
      [entries]="badgeEntries()"
      [createOptions]="{
        kind: 'SELECT',
        hotkey: 'c',
        createBadgeLabel: 'Add character',
        config: {
          options: characters(),
          valueProp: 'pk',
          labelProp: 'name',
        },
      }"
      [showHotkeyTooltip]="showHotkeyHelp()"
      [canCreate]="canCreate()"
      [canDelete]="canDelete()"
      [cancelButtonType]="'DARK'"
      (entryCreate)="onConnectionCreate($event)"
      (entryDelete)="onConnectionDelete($event)"
    ></app-badge-list>
  </div>

  <!-- Encounter Footer/Delete Toggle -->
  @if (canDelete()) {
    <app-confirmation-toggle-button
      class="card__delete-confirmer"
      [confirmationQuestion]="'Delete this encounter?'"
      [icon]="'trash'"
      [enableHotkey]="showHotkeyHelp()"
      (confirm)="onEncounterDelete()"
    ></app-confirmation-toggle-button>
  }
</ng-template>

<ng-template #updateHeading> Update "{{ encounter()?.title }}" </ng-template>

<!-- Form to Update Encounters -->
<ng-template #updateBody>
  @if (canUpdate() && state() === "UPDATE") {
    <app-form
      [model]="userModel()"
      [fields]="formlyFields()"
      [cancelButtonType]="'DARK'"
      (formlySubmit)="onEncounterUpdate(userModel())"
      (formlyCancel)="changeState('DISPLAY', undefined)"
    ></app-form>
  } @else if (canUpdate() && state() === "OUTDATEDUPDATE") {
    <app-compare-form
      [fields]="formlyFields()"
      [modelFromUser]="userModel()"
      [modelFromServer]="serverModel()"
      [displayVertically]="true"
      (formlySubmit)="onEncounterUpdate($event)"
      (formlyCancel)="changeState('DISPLAY', undefined)"
    ></app-compare-form>
  }
</ng-template>

<ng-template #createHeading> Create new Encounter </ng-template>

<!-- Form to Update Encounters -->
<ng-template #createBody>
  @if (canCreate() && state() === "CREATE") {
    <app-form
      [model]="userModel()"
      [fields]="formlyFields()"
      [cancelButtonType]="'DARK'"
      (formlySubmit)="onEncounterCreate($event)"
      (formlyCancel)="onEncounterCreateCancel()"
    ></app-form>
  }
</ng-template>
