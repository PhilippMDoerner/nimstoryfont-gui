<app-page-container>
  <article class="container character">
    @if (canUpdate()) {
      <div class="character__edit-container">
        <a [routerLink]="updateUrl()">
          <app-button [icon]="'pencil'" [type]="'SECONDARY'" />
        </a>
      </div>
    }

    <!-- Heading -->
    <div class="row">
      <h1 class="col-12 character__heading">
        @let title = character().title;
        @if (title) {
          {{ title }} -
        }
        {{ character().name }}
        @if (!character().alive) {
          (â€ )
        }
      </h1>

      <div class="col-12 character__subheading">
        <!-- Organization -->
        <h5>
          @if (character().gender !== "Other") {
            {{ character().gender }}
          }
          {{ character().race }}
          {{ playerClasses() }}
        </h5>

        <!-- Current Location -->
        @let currentLocationDetails = character().current_location_details;
        @if (currentLocationDetails) {
          <div class="col-12">
            Last known location:
            <a [routerLink]="locationUrl()">
              <strong> {{ currentLocationDetails.name }} </strong>
            </a>
          </div>
        }
      </div>
    </div>

    <div class="character__images">
      <!-- Image Gallery -->
      <app-image-carousel-card
        [images]="character().images ?? []"
        [serverUrl]="serverUrl()"
        [serverModel]="imageServerModel()"
        [canUpdate]="canUpdate()"
        [canCreate]="canCreate()"
        [canDelete]="canDelete()"
        (createImage)="createImage.emit($event)"
        (deleteImage)="deleteImage.emit($event)"
        (updateImage)="updateImage.emit($event)"
      ></app-image-carousel-card>
    </div>

    <!-- Quote -->
    <div class="character__quote">
      <app-quote-field
        [quote]="characterQuote()"
        [character]="character()"
        [campaignCharacters]="campaignCharacters()"
        [sessions]="sessions()"
        [encounters]="encounters()"
        [serverModel]="quoteServerModel()"
        [canUpdate]="canUpdate()"
        [canCreate]="canCreate()"
        [canDelete]="canDelete()"
        (refreshQuote)="refreshQuote.emit()"
        (quoteUpdate)="quoteUpdate.emit($event)"
        (quoteCreate)="quoteCreate.emit($event)"
        (quoteDelete)="quoteDelete.emit($event)"
        (connectionCreate)="quoteConnectionCreate.emit($event)"
        (connectionDelete)="quoteConnectionDelete.emit($event)"
      ></app-quote-field>
    </div>

    <div class="character__organizations">
      <app-badge-list
        [canCreate]="canCreate()"
        [canDelete]="canDelete()"
        [label]="'Organizations'"
        [entries]="organizationMemberships()"
        [createOptions]="{
          options: campaignOrganizations(),
          labelProp: 'name',
          valueProp: 'pk',
        }"
        (entryCreate)="onMembershipCreate($event)"
        (entryDelete)="organizationMembershipDelete.emit($event)"
      ></app-badge-list>
    </div>

    <div class="character__description">
      <h4>Description</h4>
      <app-html-text [text]="character().description"></app-html-text>
    </div>

    <div class="character__items">
      <app-list
        [heading]="'Items of Note'"
        [entries]="characterItems()"
        [enableCreate]="canCreate()"
        [emptyListText]="character().name + ' has no significant items.'"
        (create)="routeToItemCreate()"
      ></app-list>
    </div>

    <div class="row">
      <h4 class="col mb-0">
        <app-info-circle-tooltip
          [text]="(character().encounters?.length ?? 0) + ' Encounters'"
          [tooltip]="
            'List of all encounters with ' +
            character().name +
            '. Starts with the most recent encounter and ends with the latest.'
          "
        ></app-info-circle-tooltip>
      </h4>
      <app-encounter-accordion
        [encounters]="character().encounters ?? []"
        [campaignLocations]="campaignLocations()"
        [campaignCharacters]="campaignCharacters()"
        [serverModel]="encounterServerModel()"
        [canUpdate]="canUpdate()"
        [canCreate]="canCreate()"
        [canDelete]="canDelete()"
        (connectionCreate)="encounterConnectionCreate.emit($event)"
        (connectionDelete)="encounterConnectionDelete.emit($event)"
        (encounterDelete)="encounterDelete.emit($event)"
        (encounterUpdate)="encounterUpdate.emit($event)"
      ></app-encounter-accordion>
    </div>

    <app-article-footer
      [buttonLink]="overviewUrl()"
      [buttonLabel]="'Back to Characters'"
      [showDelete]="canDelete()"
      [deleteMessage]="'Delete ' + character().name + '?'"
      (delete)="characterDelete.emit(character())"
    ></app-article-footer>
  </article>
</app-page-container>
